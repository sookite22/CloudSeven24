<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투표 페이지</title>
</head>
<body>
    <h2 id="voteTitle">투표 제목</h2>
    <form id="voteForm">
        <div id="voteOptionsContainer">
            <!-- 동적으로 옵션 추가 -->
        </div>
        <button type="submit">투표</button>
    </form>

    <script>
        // URL에서 voteId 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const voteId = urlParams.get('voteId');

        const voteTitle = document.getElementById('voteTitle');
        const voteOptionsContainer = document.getElementById('voteOptionsContainer'); // 컨테이너 추가

        // 서버에서 투표 데이터를 가져오는 함수
        const fetchVoteDetails = async () => {
            try {
                const response = await fetch(`/api/vote/${voteId}`);
                if (!response.ok) throw new Error('Failed to fetch vote details');
                return await response.json();
            } catch (error) {
                console.error('Error fetching vote details:', error);
                alert('투표 정보를 불러올 수 없습니다.');
                window.location.href = 'home.html'; // 오류 시 홈으로 리디렉션
            }
        };

        // 투표 데이터 렌더링
        const renderVoteDetails = async () => {
            const vote = await fetchVoteDetails();

            // 제목 설정
            voteTitle.textContent = vote.title;

            // 입력 방식 설정
            const inputType = vote.selectionType === 'multiple' ? 'checkbox' : 'radio';

            // 옵션 동적 렌더링
            Object.keys(vote.options).forEach(option => {
                const optionWrapper = document.createElement('div');
                const optionInput = document.createElement('input');
                const optionLabel = document.createElement('label');

                optionInput.type = inputType;
                optionInput.name = 'voteOption';
                optionInput.value = option;
                optionInput.id = `option-${option}`;

                optionLabel.htmlFor = `option-${option}`;
                optionLabel.textContent = `${option} (현재 투표 수: ${vote.options[option]})`;

                optionWrapper.appendChild(optionInput);
                optionWrapper.appendChild(optionLabel);
                voteOptionsContainer.appendChild(optionWrapper);
            });
        };

        renderVoteDetails();

        // 투표 제출 처리
        const voteForm = document.getElementById('voteForm');
        voteForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            // 선택된 옵션들 가져오기
            const selectedOptions = Array.from(
                document.querySelectorAll('input[name="voteOption"]:checked')
            ).map(option => option.value);

            // 선택된 옵션이 없으면 경고
            if (selectedOptions.length === 0) {
                alert('최소 하나의 옵션을 선택하세요.');
                return;
            }

            try {
                const response = await fetch('/api/vote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voteId, options: selectedOptions })
             });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Server Error:', errorData);
                alert(`서버 에러: ${errorData.error || '알 수 없는 오류가 발생했습니다.'}`);
             return;
            }

            const updatedVote = await response.json();
             alert('투표가 완료되었습니다!');
            renderUpdatedVoteDetails(updatedVote);
        } catch (error) {
            console.error('Error submitting vote:', error);
            alert('네트워크 오류로 투표를 제출할 수 없습니다.');
        }
        });

        // 투표 후 옵션 결과 업데이트
        const renderUpdatedVoteDetails = (vote) => {
            // 옵션들 동적 업데이트
            const voteOptions = document.getElementById('voteOptionsContainer');
            voteOptions.innerHTML = '';  // 기존 옵션 삭제 후 다시 렌더링

            Object.keys(vote.options).forEach(option => {
                const optionWrapper = document.createElement('div');
                const optionInput = document.createElement('input');
                const optionLabel = document.createElement('label');

                optionInput.type = vote.selectionType === 'multiple' ? 'checkbox' : 'radio';
                optionInput.name = 'voteOption';
                optionInput.value = option;
                optionInput.id = `option-${option}`;

                optionLabel.htmlFor = `option-${option}`;
                optionLabel.textContent = `${option} (현재 투표 수: ${vote.options[option]})`;

                optionWrapper.appendChild(optionInput);
                optionWrapper.appendChild(optionLabel);
                voteOptions.appendChild(optionWrapper);
            });
        };
    </script>
</body>
</html>